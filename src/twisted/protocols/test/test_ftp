import mock
import twisted

from twisted.protocols.ftp import ASCIIConsumerWrapper

class ASCIIConsumerWrapperTestCase(unittest.TestCase):
    @mock.patch("twisted.protocols.ftp.os")
    def test_init(self, os_mock):
        cons_mock = mock.MagicMock()
        # Make sure the assert is working
        os_mock.linesep = ""  # Length != 1
        with self.assertRaises(AssertionError):
            ASCIIConsumerWrapper(cons_mock)

        os_mock.linesep = "\r\n"
        cons_wrapper = ASCIIConsumerWrapper(cons_mock)
        self.assertEqual(cons_wrapper.write, cons_mock.write)

    @mock.patch("twisted.protocols.ftp.os")
    def test_write(self, os_mock):
        # Mock behaviour for an OS with '\n' linesep
        bytes = b"test\n"
        os_mock.linesep = "\n"
        twisted.protocols.ftp._LINESEP_BYTES = b"\n"

        # Make sure it is properly replaced by '\r\n'
        cons_mock = mock.MagicMock()
        cons_wrapper = ASCIIConsumerWrapper(cons_mock)
        cons_wrapper.write(bytes)
        cons_mock.write.assert_called_once_with(b"test\r\n")
